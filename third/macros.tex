\usepackage{xspace}
\usepackage{ifthen}

\newif\ifdraft
 \drafttrue

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Maths
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%BNF
\newcommand\DEF{\ \ ::=\ \ }
\newcommand\OR{\ \ |\ \ }

\newcommand{\set}[1]{\{#1\}}
\newcommand{\setbar}{\ \ |\ \ }

\newcommand{\bnfis}{\ensuremath{\ \ ::=\ \ }}
\newcommand{\bnfbar}{\ensuremath{\ \ |\ \ }}


%\def\infrulestyle{\displaystyle}
%\def\infrulestyle{\textstyle}
%\def\makeinfrulesmall{\def\infrulestyle{\textstyle}}
%\def\makeinfrulenormal{\def\infrulestyle{\displaystyle}}
\newcommand{\tree}[4][] {
	\begin{array}{l}
		\ifthenelse { \equal {#1} {} }
		{}
		{
		#1
		\\
		}
		{\textstyle \frac{
			\begin{array}{c}
			#2
			\end{array}
		}{
			\begin{array}{l}
			#3
			\end{array}
		}
		}
		\ifthenelse { \equal {#4} {} }
		{}
		{
		\ #4
		}
	\end{array}
}
\newcommand{\treeline}{\\[6mm]}
\newcommand\andalso{\quad}

%\newcommand{\implies}{\Rightarrow}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Processes
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\newcommand{\sep}{.}

\newcommand\recover{\,\triangleright\,}
\newcommand\aggr[1]{\breve{#1}}
\newcommand\pout[2]{#1{}!\langle #2\rangle.}
\newcommand\pin[2]{{#1}{}?(#2).}
\newcommand\pll{\,|\,}
\newcommand{\Sum}{\ensuremath{+}\xspace}
\newcommand\sel[2]{#1\triangleleft #2.}
\newcommand\branchOn[2]{#1\,{\triangleright}\,#2}
\newcommand\branch[2]{#1\,{\triangleright}\,\{#2\}}
\newcommand\branchI[3]{\branch{#1}{{#2}_i: {#3}_i}_{i\in I}}
\newcommand{\ndet}[2]{#1 \Sum #2}
\newcommand\rec[1]{\mu #1.}
\newcommand\recvar[1]{X}
\newcommand{\Def}[2]{\ensuremath{\mathsf{def}\ #1\ \mathsf{in}\ #2} \xspace}
\newcommand{\appl}[2]{#1\langle#2\rangle}
\newcommand{\abs}[2]{#1(#2)}

\newcommand{\If}{\ensuremath{\mathsf{if}}\xspace}
\newcommand{\Then}{\ensuremath{\mathsf{then}}\xspace}
\newcommand{\Else}{\ensuremath{\mathsf{else}}\xspace}
\newcommand\cond[3]{\If\,#1\,\Then\,#2\,\Else\,#3}
\newcommand\request[2]{#1!(#2).}
\newcommand\accept[2]{#1?(#2).}
\newcommand\nil{\mathbf{0}}
\newcommand{\un}{\ensuremath{\mathsf{un}}\xspace}
\newcommand{\lin}{\ensuremath{\mathsf{lin}}\xspace}





% \newcommand{\bool}{\ensuremath{\mathsf{bool}}\xspace}
\newcommand{\true}{\ensuremath{\mathsf{true}}\xspace}
\newcommand{\false}{\ensuremath{\mathsf{false}}\xspace}


\newcommand{\newn}[1]{(\nu\,#1)}
\newcommand{\newnp}[2]{\newn{#1}(#2)}

\newcommand{\net}[2]{[#1]_{#2}}
\newcommand{\npll}{|}
\let\node\net
\newcommand{\assert}{\psi}
\newcommand{\netnil}{\node{\nil\recover\nil}{l}}

\newcommand\condtrue{\Vdash}

% Exprs and conditions
\newcommand{\econd}{\ensuremath{\varphi}\xspace}


%\newcommand\loc[1]{[#1]}
\newcommand\locl[1]{\net{#1}{l}}

\newcommand{\Par}[3]{\prod_{#1 \in #2} #3}

% \newcommand{\cnt}[2]{|#2|_{#1}}
%\newcommand{\cnt}[2]{\mathsf{cnt}(#1, #2)}
\newcommand{\cnt}[1]{\mathsf{cnt}(#1)}
\newcommand{\dom}[1]{\mathrm{dom}(#1)}
\newcommand{\U}[1]{\mathcal{U}(#1)}
\newcommand{\Linset}[1]{\mathcal{L}(#1)}


\newcommand{\mult}{\ensuremath{\odot}\xspace}
\newcommand{\sessionop}{\ensuremath{\circ}\xspace}
\newcommand{\unit}{\ensuremath{\mathbf{1}}}

\newcommand\subst[2]{\{{#1}/{#2}\}}
\newcommand\subs[2]{[{#1}/{#2}]}
% \newcommand\subst[2]{\{{}^{#1}/{}_{#2}\}}
\newcommand\reduces{\,\longrightarrow\,}

% Buffer terms

\newcommand{\squeue}[3]{\ensuremath{#1[#2, #3]}}
%\newcommand{\squeue}[2]{\ensuremath{#1[#2]}}
\newcommand{\pol}[1]{\ensuremath{\tilde{#1}}}

\newcommand{\cat}{\cdot}


\newcommand{\equeue}{\varepsilon}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Types
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcommand{\tsep}{.}

\newcommand\tout[1]{{}!#1.}
\newcommand\tin[1]{{}?#1.}
%\newcommand\tsel[2]{\oplus\{#1\mathrel:#2\}}
\newcommand\tsel[1]{\oplus\set{#1}}
%\newcommand\tselI[2]{\tsel{{#1}_i}{{#2}_i}_{i\in I}}
\newcommand\tselI[2]{\tsel{{#1}_i: {#2}_i}_{i\in I}}
\newcommand\tbranchOn[1]{\&\{#1\}}
\newcommand\tbranch[2]{\&\{#1\mathrel:#2\}}
\newcommand\tbranchI[2]{\&\{{#1}_i\mathrel:{#2}_i\}_{i\in I}}
\newcommand\tend{\mathsf{end}}
\newcommand\tvar[1]{#1}
\newcommand\trec[1]{\mu\,\tvar#1.}
\newcommand\tdual[1]{\overline{#1}}
\newcommand\tadvance{\mathrel{\shortrightarrow}}

\newcommand\tchan[3]{#1^#2[\ensuremath{\tilde{#3}]}}

\newcommand{\tempty}{\ensuremath{\varepsilon}\xspace}

% Message type
\newcommand\msel[1]{{}_{\oplus}#1.}

% Type system
\newcommand{\gthr}[2]{\ensuremath{\mathsf{V}(#1, #2)}\xspace}
\newcommand{\newbuffer}[2]{\ensuremath{\mathsf{B}(#1, #2)}\xspace}

\newcommand{\synchronise}[1]{ \ensuremath{ \mathsf{synch}(#1)}\xspace }



% Generic
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Operators on Processes
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcommand\freshfor{\mathrel{\#}}
\newcommand{\fn}[1]{\mathrm{fn}(#1)}
\newcommand{\fs}[1]{\mathrm{fs}(#1)}
\newcommand{\fv}[1]{\mathrm{fv}(#1)}
\newcommand{\Lin}[1]{\mathrm{lin}(#1)}
\newcommand{\Un}[1]{\mathrm{un}(#1)}
% \newcommand\fv{\mathrm{fv}}
\newcommand\subj{\mathrm{subj}}
\newcommand\seq[1]{\widetilde{#1}}
\newcommand\types{\mathrel{\vdash}}
\newcommand\etypes{\mathrel{\succ}}
\newcommand\expo[1]{\overline{#1}}
\newcommand\Set[1]{\{#1\}}



% Text
\newcommand\Figure[1]{Fig.~\ref{fig:#1}}
\newcommand\lemref[1]{Lem.~\ref{lem:#1}}
\newcommand\Definition[1]{Definition~\ref{#1}}
\newcommand\Section[1]{Section~\ref{sec:#1}}
\newcommand\IF{\mathrel{\mbox{if}}}
\newcommand\AND{\mathrel{\mbox{and}}}
\newcommand\OTHERWISE{\mbox{otherwise}}


% rules

\newcommand{\bool}{\mathsf{bool}}
\newcommand{\tint}{\mathsf{int}}

\def\infrulestyle{\displaystyle}
\def\makeinfrulesmall{\def\infrulestyle{\textstyle}}
\def\makeinfrulenormal{\def\infrulestyle{\displaystyle}}
\newcommand\infrule[2]{{\infrulestyle\frac{#1}{#2}}}

%\newcommand\rulename[1]{\mbox{\textsc{{\small [#1]}}}}
% \newcommand\rulename[1]{\mbox{\textsc{[#1]}}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Rule Names
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcommand\rname[1]{\ensuremath{\mathsf{{\displaystyle (#1)}}}\xspace}
\newcommand\rulename[1]{\rname{#1}}


% Syntax
\newcommand{\Request}{\rname{Request}}
\newcommand{\Accept}{\rname{Accept}}
\newcommand{\Send}{\rname{Send}}
\newcommand{\Rcv}{\rname{Receive}}
\newcommand{\Selection}{\rname{Selection}}
\newcommand{\Branching}{\rname{Branching}}
\newcommand{\Conditional}{\rname{Conditional}}
\newcommand{\NDet}{\rname{Sum}}
\newcommand{\Recursion}{\rname{Definition}}
\newcommand{\Composition}{\rname{Composition}}
\newcommand{\Inact}{\rname{Inaction}}
\newcommand{\Variable}{\rname{Variable}}
\newcommand{\Booleans}{\rname{Booleans}}


\newcommand{\Node}{\rname{Node}}
\newcommand{\Parallel}{\rname{Parallel}}
\newcommand{\Restriction}{\rname{Restriction}}

\newcommand{\EBuffer}{\rname{EBuffer}}
\newcommand{\Buffer}{\rname{Buffer}}

% Semantics
\newcommand{\Receive}{\rname{Receive}}
\newcommand{\Select}{\rname{Select}}
\newcommand{\Branch}{\rname{Branch}}
\newcommand{\True}{\rname{RTrue}}
\newcommand{\False}{\rname{RFalse}}
\newcommand{\RPar}{\rname{RPar}}
\newcommand{\RCom}{\rname{RCom}}
\newcommand{\RSel}{\rname{RSel}}
\newcommand{\RCong}{\rname{RCong}}
\newcommand{\RRes}{\rname{RRes}}

% Types
\newcommand{\Expr}{\rname{Expr}}
\newcommand{\Cond}{\rname{Cond}}
\newcommand{\CWk}{\rname{CWk}}
\newcommand{\SWk}{\rname{SWk}}
\newcommand{\SSt}{\rname{SSt}}

\newcommand{\BEmp}{\rname{BEmp}}
\newcommand{\SExp}{\rname{SExp}}
\newcommand{\SLab}{\rname{SLab}}
\newcommand{\LExp}{\rname{LExp}}
\newcommand{\BPar}{\rname{BPar}}

\newcommand{\TReq}{\rname{TReq}}
\newcommand{\TAcc}{\rname{TAcc}}
\newcommand{\TSnd}{\rname{TSnd}}
\newcommand{\TSndVal}{\rname{TSndVal}}
\newcommand{\TRcv}{\rname{TRcv}}
\newcommand{\TRcvVal}{\rname{TRcvVal}}
\newcommand{\TSel}{\rname{TSel}}
\newcommand{\TBr}{\rname{TBr}}


\newcommand{\TCond}{\rname{TCond}}

\newcommand{\TInact}{\rname{TInact}}
\newcommand{\TVar}{\rname{TVar}}
\newcommand{\TVal}{\rname{TVal}}
\newcommand{\TRec}{\rname{TRec}}
\newcommand{\TSum}{\rname{TSum}}

\newcommand{\TNode}{\rname{TNode}}
\newcommand{\TPar}{\rname{TPar}}
\newcommand{\TRes}{\rname{TRes}}



% Context
\newcommand{\econtext}{\ensuremath{\emptyset}\xspace}


\newcommand{\myparagraph}[1]{\noindent{\em #1.}\xspace}
% \newcommand{\myparagraph}[1]{{\noindent \em #1}}

\newcommand\marginnote[2]{
    \ifdraft%
        {\color{#1}$*$}\marginpar{\scriptsize{*{\color{#1}#2}}}
    \fi%
}

% \newcommand\TODO[1]{}
%\newcommand\TODO[1]{\marginnote{red}{TODO: #1}}
\newcommand\dk[1]{\marginnote{blue}{DK: #1}}
\newcommand\rg[1]{\marginnote{magenta}{RG: #1}}
\newcommand\sjg[1]{\marginnote{red}{SJG: #1}}

\newcommand{\role}[1]{\ensuremath{\mathtt{#1}}\xspace}
\newcommand{\p}{\role{p}}
\newcommand{\q}{\role{q}}
\newcommand{\m}{\role{m}}
\newcommand{\gto}{\rightarrow}
\newcommand{\gval}[3]{\role{#1} \gto \role{#2}: #3;}
\newcommand{\gsel}[3]{\role{#1} \gto \role{#2} : \{#3\}}
\newcommand{\ginact}{\mathtt{end}}

\newcommand{\mytype}[1]{\ensuremath{\mathtt{#1}}\xspace}

\newcommand{\sender}{\mytype{s}}
\newcommand{\medium}{\mytype{m}}
\newcommand{\recv}{\mytype{r}}
\newcommand{\lost}{\mytype{lost}}

\newcommand{\myprocess}[1]{\ensuremath{\mathsf{#1}}\xspace}

\newcommand{\Sender}{\myprocess{S}}
\newcommand{\Medium}{\myprocess{M}}
\newcommand{\Receiver}{\myprocess{R}}

\newcommand{\out}[4]{#1[#2][#3]!\langle #4\rangle.}
\newcommand{\inp}[4]{#1[#2][#3]?(#4).}
\newcommand{\ssel}[4]{#1[#2][#3]\triangleleft #4.}
\newcommand{\bra}[4]{#1[#2][#3]\triangleright\{#4\}}

\newcommand{\dkextend}[1]{{\color{blue} #1}}
