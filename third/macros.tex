\usepackage{xspace}
\usepackage{ifthen}
\usepackage{amssymb}

\newif\ifdraft
 \drafttrue

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Maths
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%BNF
\newcommand\DEF{\ \ ::=\ \ }
\newcommand\OR{\ \ |\ \ }

\newcommand{\set}[1]{\{#1\}}
\newcommand{\setbar}{\mathrel{|}}

\newcommand{\bnfis}{\ensuremath{\ \ ::=\ \ }}
\newcommand{\bnfbar}{\ensuremath{\ \ |\ \ }}


%\def\infrulestyle{\displaystyle}
%\def\infrulestyle{\textstyle}
%\def\makeinfrulesmall{\def\infrulestyle{\textstyle}}
%\def\makeinfrulenormal{\def\infrulestyle{\displaystyle}}

\newcommand{\tree}[4][] {
%	\def\arraystretch{1}
	\begin{array}{l}
		\ifthenelse { \equal {#1} {} }
		{}
		{
		#1
		\\
		}
		{\textstyle \frac{
			\begin{array}{c}
			#2
			\end{array}
		}{
		%	\def\arraystretch{1.4}
			\begin{array}{l}
%				\rule{0pt}{4mm} 
				#3
			\end{array}
		}
		}
		\ifthenelse { \equal {#4} {} }
		{}
		{
		\ #4
		}
	\end{array}
}
\newcommand{\treeline}{\\[4mm]}
\newcommand\andalso{\quad}

\newcommand{\btree}[4][]{
	\boxed{
		\tree[#1]{
			#2
		}{
			#3
		}{#4}
	}
}

%\newcommand{\implies}{\Rightarrow}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Processes
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\newcommand{\sep}{.}

\newcommand\recover{\,\triangleright\,}
\newcommand\aggr[1]{\breve{#1}}
\newcommand\dual[1]{\overline{#1}}
\newcommand\pout[2]{#1{}_!\langle #2\rangle.}
\newcommand\pin[2]{{#1}{}_?(#2).}
\newcommand\pll{\,|\,}
\newcommand{\Sum}{\ensuremath{+}\xspace}
\newcommand\sel[2]{#1\triangleleft #2.}
\newcommand\branchOn[2]{#1\,{\triangleright}\,#2}
\newcommand\branch[2]{#1\,{\triangleright}\,\{#2\}}
\newcommand\branchI[3]{\branch{#1}{{#2}_i: {#3}_i}_{i\in I}}
\newcommand{\ndet}[2]{#1 \Sum #2}
\newcommand\rec[1]{\mu #1.}
\newcommand\recvar[1]{X}

\newcommand{\defi}{\ensuremath{\mathsf{def}}\xspace}
\newcommand{\Def}[2]{\ensuremath{\defi\ #1\ \mathsf{in}\ #2} \xspace}
\newcommand{\appl}[2]{\ensuremath{#1\langle#2\rangle}\xspace}
\newcommand{\abs}[2]{\ensuremath{#1(#2)}\xspace}

\newcommand{\defeq}{\ensuremath{\stackrel{\mathsf{def}}{=}}\xspace}

\newcommand{\If}{\ensuremath{\mathsf{if}}\xspace}
\newcommand{\Then}{\ensuremath{\mathsf{then}}\xspace}
\newcommand{\Else}{\ensuremath{\mathsf{else}}\xspace}
\newcommand\cond[3]{\If\,#1\,\Then\,#2\,\Else\,#3}
\newcommand\request[2]{#1_!(#2).}
\newcommand\accept[2]{#1_?(#2).}
\newcommand\nil{\mathbf{0}}

\newcommand{\newn}[1]{(\nu\,#1)}
\newcommand{\newnp}[2]{\newn{#1}(#2)}

\newcommand{\net}[1]{[#1]}
\newcommand{\npll}{\,|\!|\,}
\let\node\net
\newcommand{\assert}{\psi}
\newcommand{\netnil}{\node{\nil\recover\nil}}

\newcommand\condtrue{\Vdash}

% Exprs and conditions
\newcommand{\econd}{\ensuremath{\varphi}\xspace}

\newcommand{\Par}[3]{\prod_{#1 \in #2} #3}

\newcommand{\dom}[1]{\mathrm{dom}(#1)}


\newcommand{\mult}{\ensuremath{\odot}\xspace}
\newcommand{\unit}{\ensuremath{\mathbf{1}}}

\newcommand\subst[2]{\{{#1}/{#2}\}}
% \newcommand\subst[2]{\{{}^{#1}/{}_{#2}\}}

% Reduction system
\newcommand\reduces{\mathrel{\longrightarrow}}

\newcommand{\gthr}[2]{\ensuremath{\mathsf{V}(#1, #2)}\xspace}
\newcommand{\newbuffer}[2]{\ensuremath{\mathsf{B}(#1, #2)}\xspace}


% Buffer terms

\newcommand{\ebuffer}{\ensuremath{\varepsilon}\xspace}

\newcommand{\squeue}[3]{\ensuremath{#1[#2, #3]}}
\newcommand{\pol}[1]{\ensuremath{\tilde{#1}}}
\newcommand{\cat}{\cdot}
\newcommand{\equeue}{\ensuremath{\varepsilon}\xspace}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Types
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\newcommand{\tsep}{.}

\newcommand\tout[1]{{}_!#1.}
\newcommand\tin[1]{{}_?#1.}
\newcommand\tsel[1]{\oplus\set{#1}}
\newcommand\tselI[2]{\tsel{{#1}_i: {#2}_i}_{i\in I}}
\newcommand\tbranchOn[1]{\&\{#1\}}
\newcommand\tbranch[2]{\&\{#1\mathrel:#2\}}
\newcommand\tbranchI[2]{\&\{{#1}_i\mathrel:{#2}_i\}_{i\in I}}
\newcommand\tend{\mathsf{end}}
\newcommand\tvar[1]{#1}
\newcommand\trec[1]{\mu\,\tvar#1.}
\newcommand\tdual[1]{\overline{#1}}
\newcommand\tadvance{\mathrel{\shortrightarrow}}

\newcommand{\tempty}{\ensuremath{\varepsilon}\xspace}

% Context
\newcommand{\econtext}{\ensuremath{\emptyset}\xspace}

% Message type
\newcommand\msel[1]{{}_{\oplus}#1}
\newcommand{\mtout}[1]{{}_{!}#1}
\newcommand{\sessionop}{\ensuremath{\circ}\xspace}

\newcommand{\synchronise}[2]{\ensuremath{#1 \mathrel{\hookrightarrow} #2}}



% Generic
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Operators on Processes
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%\newcommand\freshfor{\mathrel{\#}}
\newcommand{\fn}[1]{\mathrm{fn}(#1)}
\newcommand{\fs}[1]{\mathrm{fs}(#1)}
\newcommand{\fv}[1]{\mathrm{fv}(#1)}
\newcommand\subj{\mathrm{subj}}
\newcommand\seq[1]{\widetilde{#1}}
\newcommand\types{\mathrel{\vdash}}
\newcommand\etypes{\mathrel{\succ}}



% Text
\newcommand\Figure[1]{Fig.~\ref{fig:#1}}
\newcommand\lemref[1]{Lem.~\ref{lem:#1}}
\newcommand\Definition[1]{Definition~\ref{#1}}
\newcommand\Section[1]{Section~\ref{sec:#1}}
\newcommand\IF{\mathrel{\mbox{if}}}
\newcommand\AND{\mathrel{\mbox{and}}}

% rules

\newcommand{\bool}{\mathsf{bool}}

\def\infrulestyle{\displaystyle}
\def\makeinfrulesmall{\def\infrulestyle{\textstyle}}
\def\makeinfrulenormal{\def\infrulestyle{\displaystyle}}
\newcommand\infrule[2]{{\infrulestyle\frac{#1}{#2}}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Rule Names
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcommand\rname[1]{\ensuremath{\small \textsc{{[#1]}}}\xspace}
\newcommand\rulename[1]{\rname{#1}}

\newcommand\sname[1]{\ensuremath{\mathsf{(#1)}}\xspace}

% Syntax
\newcommand{\Request}{\sname{Request}}
\newcommand{\Accept}{\sname{Accept}}
\newcommand{\Send}{\sname{Send}}
\newcommand{\Rcv}{\sname{Receive}}
\newcommand{\Selection}{\sname{Select}}
\newcommand{\Branching}{\sname{Branch}}
\newcommand{\Conditional}{\sname{Cond}}
\newcommand{\NDet}{\sname{Sum}}
\newcommand{\Recursion}{\sname{Definition}}
\newcommand{\PVar}{\sname{PVar}}
\newcommand{\Inact}{\sname{Inaction}}

\newcommand{\Node}{\sname{Node}}
\newcommand{\Parallel}{\sname{Parallel}}
\newcommand{\Restriction}{\sname{Restr}}

%\newcommand{\EBuffer}{\sname{EBuffer}}
%\newcommand{\Buffer}{\sname{Buffer}}

% Semantics
\newcommand{\Connect}{\rname{Connect}}
\newcommand{\Broadcast}{\rname{Broadcast}}
\newcommand{\Unicast}{\rname{Unicast}}
\newcommand{\Receive}{\rname{Receive}}
\newcommand{\Gather}{\rname{Gather}}
\newcommand{\Select}{\rname{Select}}
\newcommand{\Branch}{\rname{Branch}}
\newcommand{\Loss}{\rname{Loss}}
\newcommand{\Recover}{\rname{Recover}}
\newcommand{\RecoverB}{\rname{RecoverB}}
\newcommand{\True}{\rname{True}}
\newcommand{\False}{\rname{False}}
\newcommand{\NonDet}{\rname{NDet}}
\newcommand{\RDef}{\rname{Def}}
\newcommand{\RPar}{\rname{RPar}}
\newcommand{\RCong}{\rname{RCong}}
\newcommand{\RRes}{\rname{RRes}}

% Types
\newcommand{\Expr}{\rname{Expr}}
\newcommand{\Cond}{\rname{Cond}}
\newcommand{\CWk}{\rname{CWk}}
\newcommand{\SWk}{\rname{SWk}}
\newcommand{\SSt}{\rname{SSt}}

\newcommand{\BEmp}{\rname{BEmp}}
\newcommand{\SEmp}{\rname{SEmp}}
\newcommand{\SExp}{\rname{SExp}}
\newcommand{\SLab}{\rname{SLab}}
\newcommand{\LExp}{\rname{LExp}}
\newcommand{\BPar}{\rname{BPar}}

\newcommand{\TReq}{\rname{TReq}}
\newcommand{\TAcc}{\rname{TAcc}}
\newcommand{\TSnd}{\rname{TSnd}}
\newcommand{\TRcv}{\rname{TRcv}}
\newcommand{\TSel}{\rname{TSel}}
\newcommand{\TBr}{\rname{TBr}}


\newcommand{\TCond}{\rname{TCond}}

\newcommand{\TInact}{\rname{TInact}}
\newcommand{\TVar}{\rname{TVar}}
\newcommand{\TRec}{\rname{TRec}}
\newcommand{\TSum}{\rname{TSum}}

\newcommand{\TNode}{\rname{TNode}}
\newcommand{\TSynch}{\rname{TSynch}}
\newcommand{\TPar}{\rname{TPar}}
\newcommand{\TCRes}{\rname{TCRes}}
\newcommand{\TSRes}{\rname{TSRes}}


% Error Nodes
\def\nname#1{\textsc{#1}\xspace}
\newcommand{\Nbrc}{\nname{Brc}}
\newcommand{\Nuni}{\nname{Uni}}
\newcommand{\Ngth}{\nname{Gth}}
\newcommand{\Nrcv}{\nname{Rcv}}
\newcommand{\Nsel}{\nname{Sel}}
\newcommand{\Nbra}{\nname{Bra}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Examples
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%\newcommand{\role}[1]{\ensuremath{\mathtt{#1}}\xspace}
%\newcommand{\p}{\role{p}}
%\newcommand{\q}{\role{q}}
%\newcommand{\m}{\role{m}}
%\newcommand{\gto}{\rightarrow}
%\newcommand{\gval}[3]{\role{#1} \gto \role{#2}: #3;}
%\newcommand{\gsel}[3]{\role{#1} \gto \role{#2} : \{#3\}}
%\newcommand{\ginact}{\mathtt{end}}

\newcommand{\mytype}[1]{\ensuremath{\mathtt{#1}}\xspace}
\newcommand{\nat}{\mytype{nat}}
%
%\newcommand{\sender}{\mytype{s}}
%\newcommand{\medium}{\mytype{m}}
%\newcommand{\recv}{\mytype{r}}
%\newcommand{\lost}{\mytype{lost}}

\newcommand{\myprocess}[1]{\ensuremath{\mathsf{#1}}\xspace}

\newcommand{\Sender}{\myprocess{Sender}}
\newcommand{\Medium}{\myprocess{Medium}}
\newcommand{\Receiver}{\myprocess{Receiver}}

\newcommand{\queue}[2]{\ensuremath{#1[#2]}}

%\newcommand{\out}[4]{#1[#2][#3]!\langle #4\rangle.}
%\newcommand{\inp}[4]{#1[#2][#3]?(#4).}
%\newcommand{\ssel}[4]{#1[#2][#3]\triangleleft #4.}
%\newcommand{\bra}[4]{#1[#2][#3]\triangleright\{#4\}}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Examples
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\def\ba{\beta_1}
\def\bb{\beta_2}

% protocol phases
\newcommand{\PreparePh}{\ensuremath{\mathsf{Prepare}}\xspace}
\newcommand{\AcceptPh}{\ensuremath{\mathsf{Accept}}\xspace}

% processes and networks
\newcommand{\Proposer}{\myprocess{Proposer}}
\newcommand{\ProposerDef}[1]{\abs{\Proposer}{#1}}
\newcommand{\ProposerVar}[1]{\appl{\Proposer}{#1}}

\newcommand{\ProposerNode}{\ensuremath{\mathsf{ProposerNode}}\xspace}


\newcommand{\Acceptor}{\myprocess{Acceptor}}
\newcommand{\AcceptorDef}[1]{\abs{\Acceptor}{#1}}
\newcommand{\AcceptorVar}[1]{\appl{\Acceptor}{#1}}

\newcommand{\AcceptorNode}{\ensuremath{\mathsf{AcceptorNode}}\xspace}


\newcommand{\Acc}{\myprocess{Acc}}
\newcommand{\AccDef}[1]{\abs{\Acc}{#1}}
\newcommand{\AccVar}[1]{\appl{\Acc}{#1}}


\newcommand{\Paxos}{\ensuremath{\mathsf{Paxos}}\xspace}
\newcommand{\PaxosDef}[1]{\abs{\Paxos}{#1}}
\newcommand{\PaxosVar}[1]{\appl{\Paxos}{#1}}
\newcommand{\PaxosNode}{\ensuremath{\mathsf{PaxosNode}}\xspace}


%labels
\newcommand{\restart}{\ensuremath{\mathsf{restart}}\xspace}
\newcommand{\acceptPhase}{\ensuremath{\mathsf{accept}}\xspace}
\newcommand{\chosen}{\ensuremath{\mathsf{chosen}}\xspace}
\newcommand{\Max}[1]{\ensuremath{\mathsf{max}(#1)}\xspace}


% Types

\newcommand{\messageTuple}{(\rnumber, \pvalue)}
\newcommand{\prep}{\mytype{prep}}
\newcommand{\prom}{\mytype{prom}}

\newcommand{\rnumber}{\mytype{rnd}}
\newcommand{\pvalue}{\mytype{value}}

\newcommand{\PaxosType}{\ensuremath{\mathsf{PaxosType}}\xspace}
%\newcommand{\AcceptorType}{\ensuremath{\mathsf{AcceptorType}}\xspace}


%\newcommand{\tuple}{\ensuremath{\mathsf{ituple}}\xspace}
%\newcommand{\prep}{\ensuremath{\mathsf{prepare}}\xspace}
%\newcommand{\prom}{\ensuremath{\mathsf{promise}}\xspace}
%\newcommand{\rnumber}{\ensuremath{\mathsf{rnum}}\xspace}
%\newcommand{\PVal}{\ensuremath{\mathsf{PVal}}\xspace}



%\newcommand\pn[1]{\textsc{#1}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Misc
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\newcommand{\myparagraph}[1]{\noindent{\em #1.}\xspace}
% \newcommand{\myparagraph}[1]{{\noindent \em #1}}

\newcommand\marginnote[2]{
    \ifdraft%
        {\color{#1}$*$}\marginpar{\scriptsize{*{\color{#1}#2}}}
    \fi%
}

% \newcommand\TODO[1]{}
%\newcommand\TODO[1]{\marginnote{red}{TODO: #1}}
\newcommand\dk[1]{\marginnote{blue}{DK: #1}}
\newcommand\rg[1]{\marginnote{magenta}{RG: #1}}
\newcommand\sjg[1]{\marginnote{red}{SJG: #1}}


\newcommand{\dkextend}[1]{{\color{blue} #1}}
